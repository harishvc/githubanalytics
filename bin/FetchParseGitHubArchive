#!/usr/bin/env node 
//http://www.spacjer.com/blog/2014/02/10/defining-node-dot-js-task-for-heroku-scheduler/
console.log("1");
var fs = require('fs');
var util = require('util');
console.log("2");
var path = require("path");
var tmp_dir = path.join(process.cwd(), "tmp/");
if (!fs.existsSync(tmp_dir))
    fs.mkdirSync(tmp_dir);
var p1 = tmp_dir + 'FetchParseGitHubArchive.log';
var p2 = tmp_dir + 'PushEvent.json';
console.log (p1);
console.log (p2);
var logStream = fs.createWriteStream(p1, {flags: 'a'});
console.log = function(d) { 
  logStream.write(util.format(d) + '\n');
};
console.log("3");

var archive = require('./mikeal-githubarchive.js');
console.log("4");

//var path = require('path');
var assert = require('assert');
var underscore = require('underscore');
var moment = require('moment');
var TimeNow = moment().format("YYYY-MM-DD HH:MM:SS");
var TimeAgo = moment().subtract(2, 'hours').format("YYYY-MM-DD-H");
console.log("5");

//Testing
//TimeAgo ="2014-08-28-10"  
URL = "http://data.githubarchive.org/" + TimeAgo + ".json.gz";
console.log (TimeNow + " processing " + URL);

//Fetch GitHub Archives & Generate JSON file with 'PushEvent' event notifications
var a = archive(URL, {gzip:true});
var com = a.MyParser(function (err, commits) {
  console.log(JSON.stringify(com.commits));
  fs.writeFile(p2, JSON.stringify(com.commits), function (err) {
	  if (err) return console.log(err);
	});
  if (err) return console.log(err);
})
